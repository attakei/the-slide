===========================
Mastering Sphinx Extensions
===========================

.. revealjs-section::
   :data-background-image: _static/background/1.png

.. revealjs-notes:: 

    これから発表を始めます。
    タイトルはスライドの通り<タイトル名>です。

Enhancing the Document Builder to Create Presentations

Introduction
============

Speaker introduction
--------------------

.. revealjs-notes:: 

   私の名前は「武居和也」です。
   日本でソフトウェアエンジニアとして働いています。
   プライベートでは、主にSphinx拡張を趣味で書いています。
   一昨日が誕生日でしたが、新しい年に新しい挑戦をさせてくれてありがとうございます。

.. container:: flex

   .. container:: size-2

      * Kazuya Takei ( ``@attakei`` )
      * Software engineer using Python in Japan
      * Sphinx lover and Sphinx extensions writer

   .. container:: size-1

      .. figure:: https://www.attakei.net/_static/images/icon-attakei.jpg
 
.. revealjs-fragments:: 

   **My birth is Feb, 27th (before yesterday!)**

Outline of this talk
--------------------

.. revealjs-notes:: 

    今回のトークのアウトラインです。
    最初に、Sphinnxの概要と拡張の仕組みについて話します。
    次に、今回のベースとなるsphinx-revealjsについての話をします。
    最後に、sphinx-revealjsを利用した、プレゼンテーションコンテンツのショーケースを見てもらいます。

* About Sphinx with advanced topic than standard usage.
* Approach to build presentations by Sphinx using sphinx-revealjs.
* Show case for power of Sphinx and sphinx-revealjs.

Excuse me
---------

.. revealjs-notes::

    申し訳ないのですが、英語ができる方ではありません。
    もし自分がうまく聞き取れなさそうであれば、後ほど以下のSNSやGitHubリポジトリにテキストで質問を投げかけてください。
    可能な限り答えます。

* I am not good to use English.
* Please post questions as text if you can.

  * https://x.com/attakei
  * https://github.com/attakei/slides

Sphinx overview
===============

.. revealjs-notes:: 

    まずは、Sphinxの紹介から始めます。

Ask questions for you
---------------------

.. revealjs-notes:: 

    せっかくなので、簡単な質問を投げさせてください。
    もしYesであれば手を上げてください。

    最後まで手を上げた人は、しばらく知っている内容が続くかもしれません。

Please raise a hand if Yes.

.. revealjs-fragments:: 

   * Do you know Sphinx?
   * Do you see document generated by Sphinx?
   * Do you write document by Sphinx?

What is Sphinx?
---------------

.. revealjs-notes:: 

    Sphinxは「Python製のドキュメントジェネレーター」です。
    プレーンテキストのソースをもとに、様々な出力を行います。
    ソースにreStructuredTextを用いつつ、多くの機能を提供します。

.. container:: flex
   
   .. container:: size-1

      .. figure:: _static/images/sphinx-logo.svg

   .. container:: size-2

      Sphinx is "documentation generator" written by Python.

      * Convert document sources into readable style output.
      * Provide features for documentation using reStructuredText.

.. revealjs-break::

.. revealjs-notes:: 

    Sphinxは様々なファイルの入出力に対応しています。
    入力ソースとしては、reStructuredTextやMarkdownを利用できます。
    出力先としては、HTML、EPUB、PDFを始め、多くの種類があります。

.. container:: flex
   
   .. container:: size-1

      .. figure:: _static/images/sphinx-logo.svg

   .. container:: size-2

      Sphinx supports multiple inputs and outputs.
      
      * Input: reStructuredText, Markdown, and more.
      * Output: HTML, PDF, EPUB, mandoc, and more.

.. revealjs-break::

.. revealjs-notes:: 

    今回は基本的に触れませんが、似たプロダクトとしては、下記のものが挙げられます。
    MkDocsについては他のPythonプロジェクトでもドキュメント生成に採用されていることが多いでしょう。

Appendix: Related products

* Pelican (written by Python)
* MkDocs (written by Python)
* Pandoc
* Hugo
* Astro

Made in Sphinx
--------------

.. revealjs-notes:: 

    Sphinxは様々なPythonプロジェクトでドキュメント生成に利用されています。

Python and third party projects:

.. container:: r-stack

   .. revealjs-fragments::

      .. figure:: _static/images/screenshot-python-doc.png
         :width: 80%
   
      .. figure:: _static/images/screenshot-django-doc.png
         :width: 80%

      .. figure:: _static/images/screenshot-numpy-doc.png
         :width: 80%

..
   * Python documentation
   * Django documentation
   * Documentations of PyData projects.

.. revealjs-break::

.. revealjs-notes:: 

    SphinxはPython関連ではないプロダクトでも使われることがあります。

Not Python:

.. container:: r-stack

   .. revealjs-fragments::

      .. figure:: _static/images/screenshot-linux-kernel.png
         :width: 70%
   
      .. figure:: _static/images/screenshot-phpmyadmin-manual.png
         :width: 70%

      .. figure:: _static/images/screenshot-fortran-website.png
         :width: 60%

..
   * Linux Kernel
   * phpMyAdmin (Web application to manage MySQL by PHP)
   * Carlire (Desktop application to manage e-books)
   * Fortlan language.

RE: Ask questions for you
-------------------------

.. revealjs-notes:: 

    さっきの質問のうち、最初の2個にはもうYesと言えるでしょう。
    ここからは、Sphinxがどのようにドキュメントを生成するかを説明していきます。

* |:white_check_mark:| Do you know Sphinx?
* |:white_check_mark:| Do you see document generated by Sphinx?
* |:black_square_button:| Do you write document by Sphinx?

Inside of Sphinx
================

How do Sphinx works to generate document.

4-step of working Sphinx
------------------------

.. revealjs-notes:: 

    Sphinxがドキュメントを生成する流れは大きく4段階に分かれます。

* Init: Sphinx core application with extensions.
* Read: Parse "reStructuredText" and convert into "doctree" objects.
* Transform: Modify "doctree" objects.
* Write: Create document files from "doctree" objects.

.. revealjs-break::

.. revealjs-notes:: 

    簡単なフローチャートです。

.. mermaid:: graph/sphinx-step-0.mmd

.. revealjs-break::

.. mermaid:: graph/sphinx-step-1.mmd

.. revealjs-break::

.. mermaid:: graph/sphinx-step-2.mmd

.. revealjs-break::

.. revealjs-notes:: 

    TransformフェーズではDoctreeを設定に基づいて変換します。
    たとえばi18nを利用した他言語への翻訳などが含まれます。

.. mermaid:: graph/sphinx-step-3.mmd

.. revealjs-break::

.. mermaid:: graph/sphinx-step-4.mmd

reStructuredText
----------------

.. revealjs-notes::

   ここでSphinxの標準的な入力フォーマットであるreStructuredTextについての説明をします。
   これは、プレーンテキストを構造的に記述するためのマークアップ言語で、Markdownに似ています。
   個人的にはMarkdownを比較して、拡張性が高いと考えています。

reStructuredText is plain text format of lightweight markup
to write sttrucuted document.
This is like for Markdown, (but it is more extendable than MD)

.. revealjs-break::

.. revealjs-notes::

   reStructuredTextの仕様として知っておくとよい点は、DirectiveとRoleという仕組みがあることです。
   標準のもの以外にも、自分で定義することも出来ます。

Standard specs includes:

* Directive is block synxtax. It can have some attributes and content that has nested direvctives.
* Role is inline directive. It can have some parameters.
* Comment ``..`` only directive. Nested content is not used for output.

.. revealjs-break::

Example with Markdown

.. revealjs-notes:: 

    reStructuredTextとMarkdownを並べてみました。

.. container:: flex

   .. container:: size-1

      reStructuredText

      .. code-block:: rst

         Title
         =====

         Hello world.

         * List item 1
         * List item 2

         .. code-block:: python

            print("hello world")

   .. container:: size-1

      Markdown

      .. code-block:: markdown

         # Title

         Hello world.

         * List item 1
         * List item 2

         ```python
         print("Hello world")
         ```

Parse to doctree
----------------

Reader convert from reStructuredText into node tree model.

.. revealjs-break::

.. container:: flex

   .. container:: size-1

      reStructuredText

      .. revealjs-code-block:: rst
         :data-line-numbers: 1-14|1,2|4|6,7|9,10|12-14|

         Title
         =====

         Hello world.

         Sub title
         ---------

         * List item 1
         * List item 2

         .. code-block:: python

            print("hello world")
   
   .. container:: size-1

      Doctree

      .. mermaid:: ./graph/doctree.mmd

Write content
-------------

Write phase generate from doctree to files rules of itself.

.. revealjs-break::

.. container:: flex

   .. container:: size-1

      Doctree

      .. mermaid:: ./graph/doctree.mmd

   .. container:: size-1

      reStructuredText

      .. revealjs-code-block:: html

         <section>
           <h1>Title</h1>
           <p>Hello world</p>
           <section>
             <h2>Sub title</h2>
             <ul>
               <li>List item1</li>
               <li>List item2</li>
             </ul>
             <code>
               <pre></pre>
             </code>
           </section>
         </section>
   
Extend Sphinx
=============

When you don't work by basic features,
what can you do?

Sphin can extend by other Python project.
-----------------------------------------

* When you want to change design of document.
* When you want to use Markdown as document source.
* When you want to display graphs in your document.
* When you want to ...

.. revealjs-fragments:: 

   We can install and use **Sphinx extensions**.

Famous extensions
-----------------

* | MyST-parser
  |   Enable to parse Markdown text with extended syntax.
* | sphinxcontrib-mermaid
  |   Render mermaid.js graph

See https://github.com/topics/sphinx-extension
to know more extensions.

Um, there are not extensions to realize that you want.
------------------------------------------------------

.. revealjs-fragments::

   You can create extensions!!

Very simple Sphinx extension
----------------------------

Write ``my_extension.py``.

.. code-block:: python

   from sphinx.application import Sphinx

   def setup(app: Sphinx) -> dict:
       print("Working this extension!")
       # Call methods of app....
       return {}

.. revealjs-break::

Edit your ``conf.py`` of document.

.. code-block:: python

   extensions = [
        # Register this!
        "my_extension",
   ]

.. revealjs-break::

.. todo:: Print console-result

.. code-block:: console

I want to add more behaivors!!
------------------------------

Sphinx core application provides many methods to extend behaviors of it.
And we can call every method in your ``setup()``. 

.. revealjs-break::

.. list-table::

   * - `add_config`
     - Add new configuration definition
   * - `add_directive`
     - Add new directive for writers.
   * - `add_builder`
     - Add new output format engine.
   * - `add_connect`
     - Set event handler of Sphinx events.

ref: `Sphinx documentation <https://www.sphinx-doc.org/en/master/extdev/appapi.html#module-sphinx.application>`_

Sphinx has many "events"
------------------------

.. figure:: https://www.sphinx-doc.org/en/master/_images/graphviz-8f41e3505b1f58d16c8c77a9ed7d9562fac30e74.png
   :width: 80%

.. revealjs-break::

.. container:: r-fit-text

   MANY!!

Please read docs when you need.

sphinx-revealjs
===============

Introduction of the one of my OSS.

What is sphinx-revealjs?
------------------------

sphinx-revealjs is Sphinx extension to add new builder with modules.

You can:

* generate html presentation from reStructuredText/Markdown.
* use very easy (call ``make revealjs`` instead of ``make html``)

.. revealjs-break:: 

Sphinx x Reveal.js

* | Work on Sphinx ecosystem
  | = Supports many Sphinx extensions
* Design Reveal.js and ecosystem.

Motivation
----------

* I want to use reStructuredText than Makdown.
* I want to use Sphinx extensions for good design contents

Demo
----

**This presentation is also made by sphinx-revealjs!!**

Website: https://attakei.github.io/the-slide/
Repository: https://github.com/attakei/the-slide/

This works on "Init" and "Write" phases
---------------------------------------

Writer create HTML that is for Reveal.js format instead of documentation format.

.. revealjs-break:: 

.. code-block:: rst

    Title
    =====

    Sub title
    ---------

.. revealjs-break:: 

.. container:: flex

   .. container:: size-1

      HTML builder

      .. code-block:: html

         <section>
           <h1>Title</h1>
           <section>
             <h2>Sub title</h2>
           </section>
         </section>

   .. container:: size-1

      Revealjs builder

      .. code-block:: html

         <section>
           <section>
             <h1>Title</h1>
           </section>
         </section>
         <section>
           <section>
             <h2>Sub title</h2>
           </section>
         </section>

Architecture 
------------

* Register new direvctives, builders, and configurations
* Builder use custom writer to generate HTML for Reveal.js.
* Custom writer handles added direvctives for good layout.

.. revealjs-break::

Added directives.

* ``revealjs-slide`` , ``revealjs-slide`` , ``revealjs-vertical`` 
* ``revealjs-break``
* ``revealjs-notes``
* ``revealjs-code-block``, ``revealjs-fragments``

``revealjs-break``
------------------

This is to split slides keeping section title.

.. container:: flex

    .. container:: size-1

        .. code-block:: rst

            Section 1
            ---------

            .. revealjs-break::

    .. container:: size-1

        .. mermaid::

           flowchart LR
               subgraph 'Some v-section'
                   direction TB
                   S1[title=Section1] --> S2[title=Section1]
               end

``revealjs-notes``
------------------

This is to manage speaker note per slides.
Contents of this is hidden from readers.

.. revealjs-notes::

    This text does not display on presentation.
    But, speaker can read from speaker-note.

``revealjs-code-block``
-----------------------

This is to extend Sphinx's ``code-block`` using animation.

.. revealjs-code-block:: rst
   :data-line-numbers: 1,2|4-6|4|5|6

   .. revealjs-code-block:: rst
      :data-line-numbers: 1,2|4-6|4|5|6

      Hello world
      ===========

      * List item 1
      * List item 2
      * List item 3

Benefits for users
------------------

* you can write presentations by as same as documentation.
* you can many contents from Python as Sphinx extensions.
* you can anage content as plain-text that is easy to manager on repository.

.. revealjs-break::

When content manage in GitHub...

* Check content by GitHub Actions.
* Deploy content to GitHub Pages.
* It may search easily by GitHub Copilot.

Benefits (only for me)
-----------------------

* Geven feedback that this is used by few enginieers but world wide.
* Gain use caes by community: presentation about OSGeoLive by OSGeo.
* Get a chance to talk on PyCon outside of Japan.

**It's a good loop of motivation for OSS writer!**

Show cases
==========

Examples of using other Sphinx extensions.

oEmbedPy
--------

.. code-block:: rst

   ..
      This is URL of Opening Remarks of PyCon PH 2024

   .. oembed:: https://www.youtube.com/watch?v=Cu9JIdlbnbc
      :maxwidth: 720
      :maxheight: 720

.. revealjs-break::

.. oembed:: https://www.youtube.com/watch?v=Cu9JIdlbnbc
   :maxwidth: 720
   :maxheight: 720

Plotly
------

.. code-block:: rst

   .. plotly:: 
      :fig-vars: fig1, fig2
      :include-source: false

      x = np.arange(5)
      y = x ** 2

      title = "plotly version: {}".format(plotly.__version__)
      fig1 = go.Figure(go.Scatter(x=x, y=y), layout=dict(title=title))
      fig2 = px.scatter(x=x, y=y, title=title)

.. revealjs-break::
   :notitle:

.. plotly::
   :fig-vars: fig1, fig2
   :include-source: false

   x = np.arange(5)
   y = x ** 2

   title = "plotly version: {}".format(plotly.__version__)
   fig1 = go.Figure(go.Scatter(x=x, y=y), layout=dict(title=title))
   fig2 = px.scatter(x=x, y=y, title=title)

PyVista
-------

.. code-block:: rst

   .. pyvista-plot::

      >>> import pyvista
      >>> sphere = pyvista.Sphere()
      >>> out = sphere.plot()

.. revealjs-break::
   :notitle:

.. pyvista-plot::

   >>> import pyvista
   >>> sphere = pyvista.Sphere()
   >>> out = sphere.plot()

asciinema
---------

.. code-block:: rst

   .. asciinema:: ./demo.cast
      :preload: 1
      :autoplay: 1
      :rows: 15
      :cols: 80
      :terminalfontsize: 16px

.. revealjs-break::

.. asciinema:: ./demo.cast
   :preload: 1
   :autoplay: 1
   :rows: 15
   :cols: 80
   :terminalfontsize: 16px

Nekochan
--------

.. list-table:: 

   * - :nekochan:`clap-nya;3em`
     - :nekochan:`beer-nya;3em`

There are many cats in Philippines!!

Enjoy presentation by documentation!!
=====================================

.. revealjs-notes:: 

    興味が湧いたら、sphinx-revealjsを使ってみてください。
    ありがとうございました。